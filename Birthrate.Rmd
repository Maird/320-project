---
title: "Birthrate by Country"
author: "Matthew Aird, Isabelle Stevens, Ryan Havel"
output: html_document
---
## Introduction
Did you know that over 300,000 babies are born each day? That comes down to over 200 babies a minute all around the world! There is a really good chance that you will have a child during your lifetime. There is also a good chance you will have a second child. But what about a third? A fourth? Luckily for you, we will discuss how many births a woman will have in her lifetime depending on several factors. For our analysis, we have combined three datasets consisting of information about hundreds of countries spanning all of the continents to get to a conclusion. The results are interesting. Keep reading to find out the secrets of birthrates. 

Here's A Link For More Fun Facts About Birthrates: https://www.childtrends.org/indicators/fertility-and-birth-rates 

## Required Libraries
These libaries are needed to follow along with this tutorial. 
```{r, warning = FALSE, message = FALSE}
library(gapminder)
library(tidyverse)
library(tidyr)
library(readr)
library(broom)
```

## 1. Gathering Data
The first step in the data science pipeline is data curation. This means acquiring all the data that we need to perform our analyses, and we can't perform analysis without it. For this example, we are looking at the relationship between a country's birthrate and factors such as GDP, income, and life expectancy for those countries. To do this, we need to pull Gapminder data from three sources:

(1) A CSV file containing birthrate per country by year that can be downloaded from this link under the indicator "Babies per woman":
    https://www.gapminder.org/data/
(2) A CSV file containing data on income per person that can be downloaded from this link under the indicator "Income per person":
    https://www.gapminder.org/data/
(3) A CSV file containing data on child mortality per 1000 people that can be downloaded from this link under the indicator "Child mortality":
    https://www.gapminder.org/data/
(4) and a dataframe containing life expectancy per country by year from the gapminder library.

```{r warning = FALSE, message = FALSE}
children_per_woman_total_fertility <- read_csv("children_per_woman_total_fertility.csv")
children_per_woman_total_fertility
income_per_person_gdppercapita_ppp_inflation_adjusted <- read_csv("income_per_person_gdppercapita_ppp_inflation_adjusted.csv")
income_per_person_gdppercapita_ppp_inflation_adjusted
gapdata <- data.frame(gapminder)
head(gapdata)
child_mortality_0_5_year_olds_dying_per_1000_born <- read_csv("child_mortality_0_5_year_olds_dying_per_1000_born.csv")
head(child_mortality_0_5_year_olds_dying_per_1000_born)
```

## Tidying Data

Tidying data is a point in the pipeline where you must change aspects of the datasets to handle missing data and to fit the model of a rectangular data structure. This means that each attribute must form a column, each entity must form a row, and each type of entity must form a table. There are 4 main operations that need to be done to our data in order for our analysis to be accurate:

1. Fixing the country names
2. Fixing the columns
3. Standardizing numbers
3. Joining datasets


First, there were several naming inconsistencies with countries where some data sets called Yemem "Yemen, Rep." and others just said "Yemen" this had to be fixed so all data could be included into one data set.

```{r}
gapdata$country <- as.character(gapdata$country)
gapdata$country[gapdata$country == "Yemen, Rep."] <- "Yemen"
```


Secondly, the three data sets used in this analysis have differing column semantics regarding year values. As you can see from the extensive column list on the birthrate and income per person table, they include the value of each year as its own column. This is not tidy data because the year attribute does not form a single column. This also differs from the gapminder data package which has year as a singular column. We fix this discrepancy by using the gather function. This changes the first two data sets by making year into a singular column and converting the data into a numeric type.

```{r}
income_df <- income_per_person_gdppercapita_ppp_inflation_adjusted %>% 
  gather(year, income_per_person, -country, convert = TRUE)
birthrate_df <- children_per_woman_total_fertility %>% 
  gather(year, birthrate, -country, convert = TRUE)
mortality_df <- child_mortality_0_5_year_olds_dying_per_1000_born %>%
  gather(year, child_mort_per, -country, convert = TRUE)
```

Then, we need to make our child mortality dataset a percentage. We do this to simplify our data and make it more understandable. To do this, we divide each country by 1000 because the original number given is child deaths per 1000 children.
```{r}
mortality_df$child_mort_per <- mortality_df$child_mort_per/10
```



Lastly, we need to join all four tables into a single dataframe to make analysis go more smoothly. 

```{r warning = FALSE, message = FALSE}
birthrate_df <- birthrate_df %>% 
  inner_join(gapdata, by = c("country", "year"))  %>%  
  inner_join(income_df, by = c("country", "year")) %>%
  inner_join(mortality_df, by = c("country", "year"))
```  

## 3. Exploratory Data Analysis
Now that our data has been tidied and formatted correctly, we can begin some of our analysis. Exploratory Data Analysis is a crucial part of the data science pipeline. Here we great visual aids to notice any trends or patterns with the data. This is where we will see if certain attributes affect overall birthrates. 
Let's look at our original mean and standard deviation before we do any data transformations.

```{r}
mean_birth <- mean(birthrate_df$birthrate)
mean_birth
std_birth <- sd(birthrate_df$birthrate)
std_birth
```

### 3.1 Factors to consider
Here we look at several analyses that try to understand what factors lead to the increase or decrease in a country's birthrate.

#### Birthrate vs. Income Per Person
```{r warning = FALSE, message = FALSE}
birthrate_df %>% 
    ggplot(aes(x = log10(income_per_person), y = birthrate)) + 
    geom_point() + geom_smooth(lm=loess) +
    labs(title = "Birthrate vs. Income", x = "Income", y = "Birthrate")
```

In the graph above we see that as birthrate increases, income per person decreases. This could point to a theory that lower income countries have higher birthrates due to lack of education, no family planning resources and no widely available contraception methods. Income per person is a contributing factor to birthrate.


#### Birthrate vs. Life Expectancy
```{r warning = FALSE, message = FALSE}
birthrate_df %>% 
    ggplot(aes(x = lifeExp, y = birthrate)) + 
    geom_point() + geom_smooth(lm=loess) +
    labs(title = "Birthrate vs. Life Expectancy", x = "Life Expectancy", y = "Birthrate")
```

The above graph compares birthrate and life expectancy. Our initial intuition is that life expectancy would affect birthrates. Holding birthrate as our independent variable, it seems that the life expectancy decreases as birthrates increase in a linear fashion. This is an interesting trend that makes sense. As mentioned before, many third-world countries tend to have lower life expectancies. These countries don't have access to the many contraceptive methods and education that more developed nations have. Overall, Life Expectancy seems to be a good contributing factor to birthrate.

#### Average Birthrate vs. year
```{r warning = FALSE, message = FALSE}
plot_data <- group_by(birthrate_df, year) %>% summarize(mean_birth = mean(birthrate)) 
plot_data %>%
    ggplot(aes(x = year, y = mean_birth)) + 
    geom_smooth() +
    labs(title = "Mean Birthrate vs. year", x = "Year", y = "Mean Birthrate")
```

#### Birthrate vs. Child Mortality
```{r warning = FALSE, message = FALSE}
birthrate_df %>% 
    ggplot(aes(x = child_mort_per, y = birthrate)) + 
    geom_point() + geom_smooth(lm = loess) +
    labs(title = "Birthrate vs. Child Mortality", x = "Child Mortality(percentage)", y = "Birthrate")
```


## 4. Machine Learning
Linear Model
$$Birth Rate = \beta_0 + \beta_1 * Continent + \beta_2 * Year + \beta_3 * IncomePerPerson + \beta_4 * Life Expectancy$$
```{r warning = FALSE, message = FALSE}

fit <- lm(birthrate ~ year + continent + income_per_person + lifeExp, data = birthrate_df)
broom::tidy(fit) %>% knitr::kable() 
```
Fitted vs. Residuals
```{r warning = FALSE, message = FALSE}
augmentedData <- fit %>% augment() %>% select(-.se.fit, -.hat, -.sigma, -.cooksd, -.std.resid)
augmentedData %>% ggplot(aes(x = .fitted, y = .resid)) + geom_violin()
```

Year vs. Residuals
```{r warning = FALSE, message = FALSE}
augmentedData %>% ggplot(aes(x = factor(year), y = .resid)) + geom_violin()
```

## Conclusion
---
title: "Birthrate by Country"
author: "Matthew Aird, Isabelle Stevens, Ryan Havel"
output: html_document
---
## Introduction
Did you know that over 300,000 babies are born each day? That comes down to over 200 babies a minute all around the world! There is a really good chance that you will have a child during your lifetime. There is also a good chance you will have a second child. But what about a third? A fourth? Luckily for you, we will discuss how many births a woman will have in her lifetime depending on several factors. For our analysis, we have combined three datasets consisting of information about hundreds of countries spanning all of the continents to get to a conclusion. The results are interesting. Keep reading to find out the secrets of birthrates. 

Here's A Link For More Fun Facts About Birthrates: https://www.childtrends.org/indicators/fertility-and-birth-rates 

## Required Libraries
These libaries are needed to follow along with this tutorial. 
```{r, warning = FALSE, message = FALSE}
library(gapminder)
library(tidyverse)
library(tidyr)
library(readr)
library(broom)
```

## 1. Gathering Data
The first step in the data science pipeline is data curation. This means acquiring all the data that we need to perform our analyses, and we can't perform analysis without it. For this example, we are looking at the relationship between a country's birthrate and factors such as GDP, income, and life expectancy for those countries. To do this, we need to pull Gapminder data from three sources:

(1) A CSV file containing birthrate per country by year that can be downloaded from this link under the indicator "Babies per woman":
    https://www.gapminder.org/data/
(2) A CSV file containing data on income per person that can be downloaded from this link under the indicator "Income per person":
    https://www.gapminder.org/data/
(3) and a dataframe containing life expectancy per country by year from the gapminder library.

```{r warning = FALSE, message = FALSE}
children_per_woman_total_fertility <- read_csv("children_per_woman_total_fertility.csv")
children_per_woman_total_fertility

income_per_person_gdppercapita_ppp_inflation_adjusted <- read_csv("income_per_person_gdppercapita_ppp_inflation_adjusted.csv")
income_per_person_gdppercapita_ppp_inflation_adjusted

gapdata <- data.frame(gapminder)
head(gapdata)
```

## Tidying Data

Tidying data is a point in the pipeline where you must change aspects of the datasets to handle missing data and to fit the model of a rectangular data structure. This means that each attribute must form a column, each entity must form a row, and each type of entity must form a table. There were 2 main operations that need to be done to our data in order for our analysis to be accurate:

1. Fixing the columns
2. Fixing the country names
3. Joining datasets

First, the three data sets used in this analysis have differing column semantics regarding year values. As you can see from the extensive column list on the birthrate and income per person table, they include the value of each year as its own column. This is not tidy data because the year attribute does not form a single column. This also differs from the gapminder data package which has year as a singular column. We fix this discrepancy by using the gather function. This changes the first two data sets by making year into a singular column and converting the data into a numeric type.

Secondly, there were several naming inconsistencies with countries where some data sets called Yemem "Yemen, Rep." and others just said "Yemen" this had to be fixed so all data could be included into one data set.

Lastly, we need to join all three tables into a single dataframe to make analysis go more smoothly. 

```{r warning = FALSE, message = FALSE}

gapdata$country <- as.character(gapdata$country)

gapdata$country[gapdata$country == "Yemen, Rep."] <- "Yemen"

income_df <- income_per_person_gdppercapita_ppp_inflation_adjusted %>% 
  gather(year, income_per_person, -country, convert = TRUE)

birthrate_df <- children_per_woman_total_fertility %>% 
  gather(year, birthrate, -country, convert = TRUE) %>% 
  inner_join(gapdata, by = c("country", "year"))  %>%  
  inner_join(income_df, by = c("country", "year"))
  
birthrate_df
```

## 3. Exploratory Data Analysis
Now that our data has been tidied and formatted correctly, we can begin some of our analysis.


Let's look at our original mean and standard deviation before we do any data transformations.
```{r}
mean_birth <- mean(birthrate_df$birthrate)
mean_birth

std_birth <- sd(birthrate_df$birthrate)
std_birth
```

### 3.1 Factors to consider

Here we look at several analyses that try to understand what factors lead to the increase or decrease in a country's birthrate.

#### Birthrate vs. Income Per Person
```{r warning = FALSE, message = FALSE}
birthrate_df %>% 
    ggplot(aes(x = birthrate, y = log10(income_per_person))) + 
    geom_point() + geom_smooth(lm=loess) +
    labs(title = "Birthrate vs. Income", x = "Birthrate", y = "Income")
```
In the graph above we see that as birthrate increases, income per person decreases. This could point to a theory that lower income countries have higher birthrates due to lack of education, no family planning resources and no widely available contraception methods.


#### Birthrate vs. Life Expectancy
```{r warning = FALSE, message = FALSE}
birthrate_df %>% 
    ggplot(aes(x = birthrate, y = lifeExp)) + 
    geom_point() + geom_smooth(lm=loess) +
    labs(title = "Birthrate vs. Life Expectancy", x = "Birthrate", y = "Life Expectancy")
```
#### Average Birthrate vs. year
```{r warning = FALSE, message = FALSE}
plot_data <- group_by(birthrate_df, year) %>% summarize(mean_birth = mean(birthrate)) 
plot_data %>%
    ggplot(aes(x = year, y = mean_birth)) + 
    geom_smooth() +
    labs(title = "Mean Birthrate vs. year", x = "Year", y = "Mean Birthrate")
```


## 4. Machine Learning
Linear Model
$$Birth Rate = \beta_0 + \beta_1 * Continent + \beta_2 * Year + \beta_3 * Income_Per_Person + \beta_4 * Life Expectancy$$
```{r warning = FALSE, message = FALSE}
fit <- lm(birthrate ~ year + continent + income_per_person + lifeExp, data = birthrate_df)
broom::tidy(fit) %>% knitr::kable() 
```
Fitted vs. Residuals
```{r warning = FALSE, message = FALSE}
augmentedData %>% ggplot(aes(x = .fitted, y = .resid)) + geom_violin()
```

Year vs. Residuals
```{r warning = FALSE, message = FALSE}
augmentedData %>% ggplot(aes(x = factor(year), y = .resid)) + geom_violin()
```

## Conclusion 

